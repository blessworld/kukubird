var utils=Comicview.utils,controllers=Comicview.controllers,website="http://2.coocomicserver.sinaapp.com";function tplComicVol(b,a){return'<li data-icon="false"><a href="comicpages.html" data-role="button" data-listid="'+a.toString()+'" data-vol_no="'+b.toString()+'">'+"第"+b.toString()+"卷"+"</a></li>";}function tplComicCapture(b,a){return'<li data-icon="false"><a href="comicpages.html" data-role="button" data-listid="'+a.toString()+'" data-capture_no="'+b.toString()+'">'+"第"+b.toString()+"话"+"</a></li>";}function tplHotComics(f,b){for(var c in b){var d=b[c];poto=d.first_photo;summary="暂无";if(d.summary){summary=d.summary;}var e=d.aka_name==null?"":d.aka_name,a='<li  data-icon="false"><a href="comic.html" data-akaname="'+e+'" data-comic_id="'+d.comic_id+'"><img src="'+poto+'"/><h3>'+e+"</h3><p>"+summary+"</p></a></li>";f.push(a);}}function tplComicsGroup(h,c){for(var e in c){var f=c[e].type;var b="";if(c[e].istoggle===false){b='<li data-role="list-divider" data-icon="arrow-r"><a href="#" data-itemid="'+e.toString()+'" comictype="'+f+'">'+f+'</a><span class="ui-li-count">'+c[e].comics.length.toString()+"</span></li></li>";}else{b='<li data-role="list-divider" data-icon="arrow-l"><a href="#" data-itemid="'+e.toString()+'" comictype="'+f+'">'+f+'</a><span class="ui-li-count">'+c[e].comics.length.toString()+"</span></li></li>";}if(c[e].istoggle){for(comic in c[e].comics){var a=c[e].comics[comic].first_photo;var d="暂无";if(c[e].comics[comic].summary){d=c[e].comics[comic].summary;}var g=c[e].comics[comic].aka_name==null?"":c[e].comics[comic].aka_name;b=b+'<li  data-icon="false" comictype="'+f+'"><a href="comic.html" data-akaname="'+g+'" data-itemid="'+e.toString()+'" data-comic_id="'+c[e].comics[comic].comic_id+'"><img src="'+a+'"/><h3>'+g+"</h3><p>"+d+"</p></a></li>";}}h.push(b);}}function showLoginWidget(a){$("div#"+a).find("div.coologinbtn").prepend('<div id="qq_login_connect_btn"></div>');QC.Login({btnId:"qq_login_connect_btn",scope:"all",size:"A_L"},function(d,c){var e=document.getElementById(c["btnId"]),b=['<span><img src="{figureurl}" class="{size_key}"/></span>',"<span>{nickname}</span>",'<span><a href="javascript:QC.Login.signOut();">退出</a></span>'].join("");e&&(e.innerHTML=QC.String.format(b,{nickname:QC.String.escHTML(d.nickname),figureurl:d.figureurl}));QC.Login.getMe(function(g,f){utils.setParam("qqToken",f.toString());utils.setUserToken(d.nickname,g.toString());});$("span#userloginintro").hide();if(!utils.getParam("isFirstLogin")){utils.setParam("isFirstLogin","True");}},function(b){utils.removeUserToken();utils.removeUserHistory();utils.removeParam("qqToken");utils.removeParam("isFirstLogin");utils.isLogin.prototype.singnal="False";Comicview.controllers.user.pageshow();$("span#userloginintro").show();});}controllers.index={pagebeforecreate:function(b){var c=1;if(utils.getParam("index_curr_page_no")){c=parseInt(utils.getParam("index_curr_page_no"));}else{utils.setParam("index_curr_page_no",c.toString());}if(utils.getParam("index_total_page_num")){var a=parseInt(utils.getParam("index_total_page_num"));}else{$.getJSON(website+"/gettotalpagenum?&callback=?",function(e){var d=parseInt(e.total_page);utils.setParam("index_total_page_num",d.toString());controllers.index.pageshow();});}if(!utils.getParam("all_comics")){$.getJSON(website+"/getallcomics?&callback=?",function(d){utils.setParam("all_comics",utils.object2String(d.all_comics));});}},pageshow:function(b){var d=parseInt(utils.getParam("index_curr_page_no"));var a=parseInt(utils.getParam("index_total_page_num"));$.getJSON(website+"/gethotcomics?currpageno="+d.toString()+"&callback=?",function(f){var g=['<li data-role="list-divider">热门漫画</li>'];tplHotComics(g,f.comics);var e=$("#index").find('ul[data-role="listview"]');e.html(g.join(""));e.listview("refresh");e.undelegate();e.delegate("li a","click",function(h){utils.setParam("comic_id",$(this).data("comic_id"));utils.setParam("akaname",$(this).data("akaname"));});});$("#indexpagebtn").html("");if(d>1){$("#indexpagebtn").append('<a data-inline="true" data-corners="true" data-action_page_no="'+(d-1).toString()+'" data-role="button" href="#index" data-shadow="true" data-iconshadow="true" data-wrapperels="span" '+'data-theme="c" class="ui-btn ui-btn-inline ui-shadow ui-btn-corner-all ui-btn-up-c">'+'<span class="ui-btn-inner ui-btn-corner-all"><span class="ui-btn-text">上一页</span></span></a>');}if(d<a){$("#indexpagebtn").append('<a data-inline="true" data-corners="true" data-action_page_no="'+(d+1).toString()+'" data-role="button" href="#index" data-shadow="true" data-iconshadow="true" data-wrapperels="span" '+'data-theme="c" class="ui-btn ui-btn-inline ui-shadow ui-btn-corner-all ui-btn-up-c">'+'<span class="ui-btn-inner ui-btn-corner-all"><span class="ui-btn-text">下一页</span></span></a>');}$("#indexpagebtn").append("&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp<span>页次   "+d.toString()+"/"+a.toString()+"<span>");var c=$("#indexpagebtn");c.undelegate();c.delegate("a","click",function(f){page_no=$(this).data("action_page_no");utils.setParam("index_curr_page_no",page_no);controllers.index.pageshow();});$("#SearchByAkaname").val("");},};controllers.SearchByAkaname={input:function(a,h){var j=$(this).val();if(j.length<1){controllers.index.pageshow();}else{var d=['<li data-role="list-divider">搜索结果</li>'];var g=[];var e=utils.string2Object(utils.getParam("all_comics"));for(var f=0,c=utils.getPropertyCount(e);f<c;f++){if(e[f].aka_name.indexOf(j)!=-1){g.push(e[f]);}}tplHotComics(d,g);var b=$("#index").find('ul[data-role="listview"]');b.html(d.join(""));b.listview("refresh");b.undelegate();b.delegate("li a","click",function(k){utils.setParam("comic_id",$(this).data("comic_id"));utils.setParam("akaname",$(this).data("akaname"));});}}};controllers.comic={pageshow:function(a){$.getJSON(website+"/getcomiclength?id="+utils.getParam("comic_id")+"&callback=?",function(j){var e=j.aka_name,l=j.vols,m=j.min_capture,c=j.max_capture,g=0,k=[],f=['<li data-role="list-divider">'+e+"</li>"];if(utils.getParam("reversesort")!=="true"){$("#reversesort").find("span").eq(0).text("倒序排列");k=[];g=0;for(var h=0;h<l;h++){f.push(tplComicVol(h+1,g));k.push({"listid":g,"vol_no":(h+1),"capture_no":-1});g++;}if(m>0){for(var h=m;h<=c;h++){f.push(tplComicCapture(h,g));k.push({"listid":g,"vol_no":-1,"capture_no":h});g++;}}}else{$("#reversesort").find("span").eq(0).text("正序排列");k=[];g=0;if(m>0){for(var h=c;h>=m;h--){f.push(tplComicCapture(h,g));k.push({"listid":g,"vol_no":-1,"capture_no":h});g++;}}for(var h=l;h>0;h--){f.push(tplComicVol(h,g));k.push({"listid":g,"vol_no":(h),"capture_no":-1});g++;}}utils.setParam("listid_array",utils.object2String(k));var d=$("#comic").find('ul[data-role="listview"]');d.html(f.join(""));d.listview("refresh");d.undelegate();d.delegate("li a","click",function(n){if(utils.string2Object(utils.getParam("listid_array"))[$(this).data("listid")].capture_no===-1){utils.setParam("vol_no",utils.string2Object(utils.getParam("listid_array"))[$(this).data("listid")].vol_no);utils.setParam("capture_no",-1);}else{if(utils.string2Object(utils.getParam("listid_array"))[$(this).data("listid")].vol_no===-1){utils.setParam("capture_no",utils.string2Object(utils.getParam("listid_array"))[$(this).data("listid")].capture_no);utils.setParam("vol_no",-1);}}utils.setParam("listid",parseInt($(this).data("listid")));});});var b=utils.getParam("vol_no");}};controllers.comicpages={pageshow:function(b){var a=utils.getParam("comic_id");var d=utils.getParam("vol_no");var c=utils.getParam("capture_no");$(document).keydown(controllers["currcomicpage"]["keydown"]);preloadimage.preloadInit();preloadimage.ajaxRequest(a,d,c);viewport=document.querySelector("meta[name=viewport]");viewport.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes");if(utils.getParam("vol_no")!=-1){$("#labelvolno").text("第"+utils.getParam("vol_no")+"卷");}else{if(utils.getParam("capture_no")!=-1){$("#labelvolno").text("第"+utils.getParam("capture_no")+"话");}}utils.setUserBrowseHistory();$(window).bind("orientationchange",function(e){preloadimage.resizeImg();});},pagehide:function(a){$(document).unbind("keydown",controllers["currcomicpage"]["keydown"]);viewport=document.querySelector("meta[name=viewport]");viewport.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0");$(window).unbind("orientationchange");},swipeleft:function(a){if(!preloadimage.onNextPage()){return controllers.autoGoVolCap("next");}return true;},swiperight:function(a){if(!preloadimage.onPrevPage()){return controllers.autoGoVolCap("prev");}return true;}};controllers.currcomicpage={keydown:function(a){if(a.keyCode==37){if(!preloadimage.onPrevPage()){curr_listid=utils.getParam("listid");controllers.autoGoVolCap("prev");}}else{if(a.keyCode==39){if(!preloadimage.onNextPage()){curr_listid=parseInt(utils.getParam("listid"));controllers.autoGoVolCap("next");}}}}};controllers.AutoTurnPage={"click":function(a){if(preloadimage.isAutoTurnPage()){$("#AutoTurnPage").removeClass("ui-btn-active");}else{$("#AutoTurnPage").addClass("ui-btn-active");}preloadimage.setAutoTurnPage();}};controllers.pageslider={"tap":function(a){alert($("#pageslider").attr("value"));return false;}};controllers.autoGoVolCap=function(b){var a=0;curr_listid=parseInt(utils.getParam("listid"));if(((utils.getParam("reversesort")==="true")&&(b==="next"))||((utils.getParam("reversesort")!=="true")&&(b==="prev"))){a=curr_listid-1;}else{a=curr_listid+1;}listid_array_obj=utils.string2Object(utils.getParam("listid_array"));if(((a<0)&&(utils.getParam("reversesort")!=="true"))||(a>=utils.getPropertyCount(listid_array_obj)&&(utils.getParam("reversesort")==="true"))){alert("不好意思，已经是万物之始了，前面一片空无......");return false;}else{if(((a>=utils.getPropertyCount(listid_array_obj))&&(utils.getParam("reversesort")!=="true"))||((a<0)&&(utils.getParam("reversesort")==="true"))){alert("了不起的毅力，您一口气到达漫画之路的尽头，去休息一下吧......");return false;}}listid_array_item=utils.string2Object(utils.getParam("listid_array"))[a];vol_no=listid_array_item.vol_no;capture_no=listid_array_item.capture_no;utils.setParam("vol_no",vol_no);utils.setParam("capture_no",capture_no);utils.setParam("listid",a);$.mobile.changePage("comicpages.html",{reloadPage:true},{allowSamePageTranstion:true},{transition:"none"});return true;};controllers.categories={pageshow:function(c){if(!utils.getParam("comic_type_group")){$.getJSON(website+"/getcomicbytypegroup?callback=?",function(e){for(i in e.comic_type_group){e.comic_type_group[i].istoggle=false;}utils.setParam("comic_type_group",utils.object2String(e.comic_type_group));controllers.categories.pageshow();});}else{var d=[];var b=utils.string2Object(utils.getParam("comic_type_group"));tplComicsGroup(d,b);var a=$("#categories").find('ul[data-role="listview"]');a.html(d.join(""));a.listview("refresh");a.undelegate();a.delegate("li a","click",function(f){utils.setParam("comic_id",$(this).data("comic_id"));utils.setParam("akaname",$(this).data("akaname"));});$("#categories li a").die("click",controllers["categories"]["togglelist"]);$("#categories li a").live("click",controllers["categories"]["togglelist"]);$.each($("#categories li"),function(e,f){if($(f).attr("comictype")&&b[parseInt($(f).data("itemid"))]===false){$(f).toggle("slow");}});}},togglelist:function(b){var a=utils.string2Object(utils.getParam("comic_type_group"));a[parseInt($(this).data("itemid"))].istoggle=!a[parseInt($(this).data("itemid"))].istoggle;utils.setParam("comic_type_group",utils.object2String(a));controllers.categories.pageshow();},pagehide:function(a){$("#categories li a").die("click",controllers["categories"]["togglelist"]);}};controllers.user={pagecreate:function(a){},pageshow:function(b){var a=$("#user").find('ul[data-role="listview"]');utils.getUserBrowseHistory(function(d){var f=[];for(var e=0,c=d.length;e<c;e++){if(d[e].capture==-1){f.push('<li data-icon="false"><a href="comicpages.html" data-role="button" data-vol_no="'+d[e].vol.toString()+'" data-comic_id="'+d[e].comic_id.toString()+'">'+d[e].akaname+"  第"+d[e].vol.toString()+"卷"+'</a><span class="ui-li-aside">'+d[e].datetime.toString()+"&nbsp&nbsp&nbsp&nbsp</span></li>");}else{if(d[e].vol==-1){f.push('<li data-icon="false"><a href="comicpages.html" data-role="button" data-capture_no="'+d[e].capture.toString()+'" data-comic_id="'+d[e].comic_id.toString()+'">'+d[e].akaname+"  第"+d[e].capture.toString()+"话"+'</a><span class="ui-li-aside">'+d[e].datetime.toString()+"&nbsp&nbsp&nbsp&nbsp</span></li>");}}}a.html('<li data-role="list-divider">我的浏览历史</li>');a.append(f.join(""));a.listview("refresh");a.undelegate();a.delegate("li a","click",function(g){utils.setParam("comic_id",$(this).data("comic_id"));if($(this).data("vol_no")){utils.setParam("vol_no",$(this).data("vol_no"));utils.setParam("capture_no",-1);}else{if($(this).data("capture_no")){utils.setParam("capture_no",$(this).data("capture_no"));utils.setParam("vol_no",-1);}}});});}};controllers.about={pagecreate:function(a){}};controllers.reversesort={click:function(a){if(utils.getParam("reversesort")==="true"){utils.setParam("reversesort","false");}else{utils.setParam("reversesort","true");}$.mobile.changePage("comic.html",{reloadPage:true},{allowSamePageTranstion:true},{transition:"none"});}};controllers.btn_page_next={click:function(a){if(!preloadimage.onNextPage()){return controllers.autoGoVolCap("next");}return true;}};controllers.btn_page_prev={click:function(a){if(!preloadimage.onPrevPage()){return controllers.autoGoVolCap("prev");}return true;}};var pages=[{id:"comic",event:"pageshow"},{id:"comicpages",event:"pageshow,swipeleft,swiperight,pagehide"},{id:"index",event:"pagebeforecreate,pageshow"},{id:"AutoTurnPage",event:"click"},{id:"categories",event:"pageshow,pagehide"},{id:"user",event:"pageshow"},{id:"about",event:"pagecreate"},{id:"btn_page_next",event:"click"},{id:"btn_page_prev",event:"click"},{id:"reversesort",event:"click"},{id:"SearchByAkaname",event:"input"},];Comicview.run(pages);var Comicview={author:"memoryboxes",version:"1.0",modified:"memoryboxes@163.com",website:"http://www.Comicview.com"};Comicview.utils={setParam:function(a,b){sessionStorage.removeItem(a);sessionStorage.setItem(a,b);},getParam:function(a){return sessionStorage.getItem(a);},removeParam:function(a){sessionStorage.removeItem(a);},setStorageParam:function(a,b){localStorage.removeItem(a);localStorage.setItem(a,b);},getStorageParam:function(a){return localStorage.getItem(a);},removeStorageParam:function(a){localStorage.removeItem(a);},setUserToken:function(b,a){if(sessionStorage.getItem("cootoken")){return;}else{$.getJSON(website+"/user/getusercootoken?callback=?",{"qq_name":b,"qq_uid":a},function(c){sessionStorage.setItem("cootoken",c.cootoken);Comicview.utils.isLogin.prototype.singnal="True";Comicview.controllers.user.pageshow();});}},getUserToken:function(){return sessionStorage.getItem("cootoken");},removeUserToken:function(){sessionStorage.removeItem("cootoken");},getUserBrowseHistory:function(a){var b=new Array();if(utils.getStorageParam("user_history")){b=utils.string2Array(utils.getStorageParam("user_history"));}a(b);},setUserBrowseHistory:function(){if(sessionStorage.getItem("akaname")==="undefined"){return;}var b=new Array();if(utils.getStorageParam("user_history")){b=utils.string2Array(utils.getStorageParam("user_history"));}var a=new Date().format("MM-dd hh:mm");b.unshift({"comic_id":sessionStorage.getItem("comic_id"),"akaname":sessionStorage.getItem("akaname"),"vol":sessionStorage.getItem("vol_no"),"capture":sessionStorage.getItem("capture_no"),"datetime":a});utils.setStorageParam("user_history",utils.array2String(b));},removeUserHistory:function(){sessionStorage.removeItem("histories");},isLogin:function(){},object2String:function(c){var d,a="";if(c){a+="{";for(var b in c){d=c[b];switch(typeof d){case ("object"):if(d&&d[0]){a+="'"+b+"':"+Comicview.utils.array2String(d)+",";}else{a+="'"+b+"':"+Comicview.utils.object2String(d)+",";}break;case ("string"):a+="'"+b+"':'"+encodeURI(d)+"',";break;default:a+=b+":"+d+",";}}a=a.substring(0,a.length-1)+"}";}return a;},array2String:function(d){var c,a="";if(d){a+="[";for(var b in d){c=d[b];switch(typeof c){case ("object"):if(c[0]){a+=Comicview.utils.array2String(c)+",";}else{a+=Comicview.utils.object2String(c)+",";}break;case ("string"):a+="'"+encodeURI(c)+"',";break;default:a+=c+",";}}a=a.substring(0,a.length-1)+"]";}return a;},string2Object:function(string){eval("var result = "+decodeURI(string));return result;},string2Array:function(string){eval("var result = "+decodeURI(string));return result;},getPropertyCount:function(b){var c,a=0;for(c in b){if(b.hasOwnProperty(c)){a++;}}return a;},};Comicview.controllers={};Comicview.run=function(a){var a=a,d=a.length;for(var c=0;c<d;c++){var f=a[c],h=f.id;e_array=f.event.split(",");for(var b=0;b<e_array.length;b++){var g=e_array[b];if($.trim(g).length==0){continue;}$("#"+h).live(g,Comicview.controllers[h][g]);}}Date.prototype.format=function(i){var j={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};if(/(y+)/.test(i)){i=i.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length));}for(var e in j){if(new RegExp("("+e+")").test(i)){i=i.replace(RegExp.$1,RegExp.$1.length==1?j[e]:("00"+j[e]).substr((""+j[e]).length));}}return i;};};(function(){if(!window.preloadimage){window["preloadimage"]={};}var r=new Array();var g=0;var f=-1;var n=false;var c=1;var d=6;function k(){r=[];g=0;f=-1;n=false;}window["preloadimage"]["preloadInit"]=k;function l(){if(f>=r.length-1){return false;}p(++f);$("div #currcomicpage img").eq(0).animate({width:"0"},{duration:200,complete:function(){$(this).remove();}});s();imgtext='<img class="frame" src="'+r[f].url+'">';$("div #currcomicpage").append(imgtext);var t=new Image();t.src=r[f].url;if(!r[f].hwratio){r[f].hwratio=t.height/t.width;}preloadimage.resizeImg();t.onload=function(){var u=t.height/t.width;if(u!=r[f].hwratio){r[f].hwratio=u;preloadimage.resizeImg();}};$("#labelpageno").text("第"+(f+1).toString()+"页");return true;}window["preloadimage"]["onNextPage"]=l;function e(){if(f<=0){return false;}p(--f);$("div #currcomicpage img").eq(0).slideToggle(200,function(){$(this).remove();});s();imgtext='<img class="frame" src="'+r[f].url+'">';$("div #currcomicpage").append(imgtext);var t=new Image();t.src=r[f].url;preloadimage.resizeImg();t.onload=function(){var u=t.height/t.width;if(u!=r[f].hwratio){r[f].hwratio=u;preloadimage.resizeImg();}};$("#labelpageno").text("第"+(f+1).toString()+"页");return true;}window["preloadimage"]["onPrevPage"]=e;function b(t){$("div #currcomicpage img").eq(0).hide(100,function(){$(this).remove();});imgtext='<img src="'+r[t].url+'">"';$("div #currcomicpage img").append(imgtext);p(t);}window["preloadimage"]["jumpToPage"]=b;function o(t,v,u){urllist=[];$.getJSON(website+"/getcomicpages?callback=?",{"comic_id":t,"vol":v,"capture":u},function(y){for(var x=0,w=y.imglist.length;x<w;x++){r.push({"url":y.imglist[x]});}$("#labeltotalpageno").text("共"+j().toString()+"页");l();});}window["preloadimage"]["ajaxRequest"]=o;function i(){var t=$("div #currcomicpage").find("img");hwratio=r[a()].hwratio;if($(window).width()>=$(window).height()){t.height($(window).height()-5);t.width($(t).height()/hwratio);$("div #currcomicpage img").css("margin-left",($(window).width()-t.width())/2);$("div #currcomicpage img").css("margin-top",0);}else{t.width($(window).width());t.height($(t).width()*hwratio);$("div #currcomicpage img").css("margin-bottom",($(window).height()-t.height())/2);$("div #currcomicpage img").css("margin-top",($(window).height()-t.height())/2);$("div #currcomicpage img").css("margin-left",0);}}window["preloadimage"]["resizeImg"]=i;function h(){n=!n;m();}window["preloadimage"]["setAutoTurnPage"]=h;function q(){return n;}window["preloadimage"]["isAutoTurnPage"]=q;function a(){return f;}window["preloadimage"]["getCurrPageNo"]=a;function j(){return r.length;}window["preloadimage"]["getTotalPageNo"]=j;function s(v){for(var u=1,t=$("div #currcomicpage img").length;u<t;u++){$("div #currcomicpage img").eq(u).remove();}}function p(v){min=(v-d)>0?(v-1):0;max=(v+d)>r.length?r.length:(v+d);for(var u=min;u<max;u++){var t=new Image();t.src=r[u].url;}}function m(){if(n){if(controllers.comicpages.swipeleft()){setTimeout("preloadimage._begin_auto_turn_page()",10000);}}}window["preloadimage"]["_begin_auto_turn_page"]=m;})();